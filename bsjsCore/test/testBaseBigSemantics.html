<html>

<head>
<title>Test Extraction</title>

<link rel="stylesheet" href="../../libraries/jquery.jsonview.min.css" />

<script src="../../libraries/jquery-2.0.0.min.js"></script>
<script src="../../libraries/jquery.jsonview.min.js"></script>

<script src="../../browserified/bigsemantics-core.js"></script>

<style>
.wrap {
  margin: 0.5em;
  padding: 1em;
  background-color: #C7EDDA;
}

.error {
  color: red;
}
</style>
</head>

<body>

<div class="wrap">
  <select id="testlist">
    <option value="choose">Choose ...</option>
  </select>
</div>

<div class="wrap">
  <p>Repository: <span id='repo'><a href="#"></a></span></p>
  <p>Document: <span id='doc'><a href="#"></a></span></p>
  <p>Description: <span id="description"></span></p>
  <p id="error" class="error"></p>
</div>

<div class="wrap">
  <div id="metadata"></div>
</div>

<script>
  function displayMetadata(metadata) {
  }

  var repoMan = new bigsemantics.RepoMan();
  var bs = new bigsemantics.BaseBigSemantics({
    repoMan: repoMan,
    downloaders: {
      'xhr': new bigsemantics.XhrDownloader(),
    },
    extractors: {
      'xpath': new bigsemantics.XpathExtractor(),
    },
  });

  var specs = {};

  function setupTest(spec) {
    if (spec) {
      var option = $('<option></option>').val(spec.name).text(spec.displayName);
      $('#testlist').append(option);
      specs[spec.name] = spec;
    }
  }

  function switchToTest(spec) {
    $('#repo > a').attr('href', spec.repoUrl).text(spec.repoUrl);
    $('#doc > a').attr('href', spec.docUrl).text(spec.docUrl);
    $('#description').text(spec.description);
    $('#error').text('');
    $('#metadata').empty();

    repoMan.reset();
    var downloader = new bigsemantics.XhrDownloader();
    downloader.httpGet(spec.repoUrl, {
      responseType: 'json',
    }).then(resp => {
      repoMan.load(bigsemantics.simpl.graphExpand(resp.entity));
    });

    bs.loadMetadata(spec.docUrl, {
      mmdName: spec.mmdName,
    }).then(typedMetadata => {
      bigsemantics.simpl.graphCollapse(typedMetadata);
      var json = JSON.stringify(typedMetadata, null, 4);
      $('#metadata').JSONView(json);
    }).catch(err => {
      console.error(err);
      $('#error').text(err.stack);
    });
  }

  $('#testlist').on('change', function() {
    var spec = specs[this.value];
    if (spec) {
      switchToTest(spec);
    }
  });

  setupTest({
    name: 'inherited-xpath-amazon_product',
    displayName: 'Test inherited xpaths with amazon product',
    repoUrl: 'repo-all-160711.json',
    mmdName: 'amazon_product',
    docUrl: 'amazon_product.html',
    description: 'Test inherited xpaths with amazon product. The department\
    field should not contain page-level information, such as description and\
    main_images.',
  });

  setupTest({
    name: 'inherited-xpath-fake_acm_article',
    displayName: 'Test inherited xpaths with fake ACM article',
    repoUrl: 'repo-inherited-xpaths.json',
    mmdName: 'acm_article',
    docUrl: 'fake-acm_article.html',
    description: 'Test inherited xpaths with fake ACM article. There should be\
    a source field.',
  });
</script>
</body>

</html>
